<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snapzify Photobooth</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
      }

      .photobooth-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        max-width: 1200px;
        width: 100%;
        max-height: 95vh;
        overflow-y: auto;
      }

      .header {
        background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
        color: white;
        text-align: center;
        padding: 15px;
      }

      .header h1 {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }

      .header p {
        font-size: 0.9rem;
      }

      .main-content {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding: 20px;
      }

      .camera-section {
        flex: 2;
        min-width: 300px;
      }

      .controls-section {
        flex: 1;
        min-width: 280px;
      }

      .camera-container {
        position: relative;
        background: #f8f9fa;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 15px;
        width: 100%;
        aspect-ratio: 4/3;
      }

      #video,
      #canvas {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transform: scaleX(-1);
      }

      #canvas {
        display: none;
      }

      .frame-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
      }

      .sticker-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 3;
      }

      .sticker {
        position: absolute;
        cursor: move;
        user-select: none;
        font-size: clamp(20px, 4vw, 30px);
        pointer-events: auto;
        touch-action: none;
      }

      .camera-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.85rem;
        min-width: 120px;
      }

      .btn-primary {
        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        color: white;
      }

      .btn-success {
        background: linear-gradient(45deg, #43e97b, #38f9d7);
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .control-group {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .control-group h3 {
        margin-bottom: 12px;
        color: #333;
        font-size: 1rem;
      }

      .frame-selector,
      .filter-selector,
      .sticker-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .frame-option,
      .filter-option,
      .sticker-option {
        aspect-ratio: 1;
        border: 3px solid transparent;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        background: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        font-size: 0.75rem;
        text-align: center;
        padding: 5px;
      }

      .frame-option.active,
      .filter-option.active {
        border-color: #ff6b6b;
        transform: scale(1.05);
      }

      .sticker-option {
        font-size: clamp(16px, 3vw, 20px);
        background: #fff;
      }

      .sticker-option:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .retake-counter {
        text-align: center;
        margin: 15px 0;
        font-size: 1rem;
        font-weight: bold;
        color: #666;
      }

      .photo-strip {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 15px;
      }

      .photo-slot {
        aspect-ratio: 1;
        background: #f0f0f0;
        border: 2px dashed #ccc;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: #666;
        position: relative;
        overflow: hidden;
      }

      .photo-slot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }

      .photo-delete-btn {
        position: absolute;
        top: 3px;
        right: 3px;
        background: #ff4757;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 10px;
        cursor: pointer;
        display: none;
        z-index: 10;
        transition: all 0.3s ease;
      }

      .photo-slot:hover .photo-delete-btn {
        display: block;
      }

      .photo-delete-btn:hover {
        background: #ff3742;
        transform: scale(1.1);
      }

      .download-section {
        text-align: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 2px solid #eee;
      }

      .filters {
        display: none;
      }

      @keyframes heartBeat {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      @keyframes twinkle {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }

      @keyframes neonGlow {
        0% {
          box-shadow: 0 0 30px #ff0080, inset 0 0 30px #00ffff;
        }
        100% {
          box-shadow: 0 0 50px #00ffff, inset 0 0 50px #ff0080;
        }
      }

      /* Mobile Optimizations */
      @media (max-width: 768px) {
        body {
          padding: 5px;
        }

        .photobooth-container {
          border-radius: 15px;
          max-height: none;
        }

        .header {
          padding: 12px;
        }

        .header h1 {
          font-size: 1.3rem;
        }

        .header p {
          font-size: 0.8rem;
        }

        .main-content {
          flex-direction: column;
          padding: 15px;
          gap: 15px;
        }

        .camera-section,
        .controls-section {
          min-width: unset;
          width: 100%;
        }

        .camera-container {
          aspect-ratio: 3/4; /* More portrait for mobile */
        }

        .camera-controls {
          gap: 8px;
          flex-direction: column;
          align-items: center;
        }

        .btn {
          padding: 12px 20px;
          font-size: 0.8rem;
          min-width: 150px;
          width: 100%;
          max-width: 250px;
        }

        .control-group {
          padding: 12px;
          margin-bottom: 12px;
        }

        .control-group h3 {
          font-size: 0.9rem;
          margin-bottom: 10px;
        }

        .frame-selector,
        .filter-selector,
        .sticker-selector {
          gap: 6px;
          grid-template-columns: repeat(3, 1fr);
        }

        .frame-option,
        .filter-option {
          font-size: 0.65rem;
          padding: 4px;
          min-height: 60px;
        }

        .sticker-option {
          font-size: 18px;
          min-height: 60px;
        }

        .photo-strip {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }

        .retake-counter {
          font-size: 0.9rem;
          margin: 10px 0;
        }

        .sticker {
          font-size: 24px;
        }

        .photo-delete-btn {
          width: 24px;
          height: 24px;
          font-size: 12px;
        }
      }

      @media (max-width: 480px) {
        .main-content {
          padding: 10px;
        }

        .btn {
          padding: 10px 16px;
          font-size: 0.75rem;
        }

        .frame-option,
        .filter-option {
          font-size: 0.6rem;
          padding: 3px;
        }

        .sticker-option {
          font-size: 16px;
        }
      }

      /* Touch device optimizations */
      @media (hover: none) and (pointer: coarse) {
        .photo-delete-btn {
          display: block;
          opacity: 0.8;
        }

        .btn:hover {
          transform: none;
        }

        .frame-option:hover,
        .filter-option:hover,
        .sticker-option:hover {
          transform: none;
        }

        .sticker-option:active {
          transform: scale(1.05);
        }
      }
    </style>
  </head>
  <body>
    <div class="photobooth-container">
      <div class="header">
        <h1>üì∏ Snapzify Photobooth</h1>
        <p>Ambil foto dengan berbagai frame, filter, dan sticker!</p>
      </div>

      <div class="main-content">
        <div class="camera-section">
          <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="frame-overlay" id="frameOverlay"></div>
            <div class="sticker-overlay" id="stickerOverlay"></div>
          </div>

          <div class="camera-controls">
            <button class="btn btn-primary" id="captureBtn">
              üì∑ Ambil Foto
            </button>
            <button class="btn btn-secondary" id="retakeBtn" disabled>
              üîÑ Ulangi
            </button>
            <button class="btn btn-success" id="startBtn">
              üé¨ Mulai Kamera
            </button>
            <input type="file" id="uploadImage" accept="image/*" style="display: none;" />
<button class="btn btn-secondary" onclick="document.getElementById('uploadImage').click()">
  üñº Upload dari Galeri
</button>

          </div>

          <div class="retake-counter">
            <span id="retakeCount">Sisa Retake: 3</span>
          </div>

          <div class="photo-strip">
            <div class="photo-slot" id="slot1">Foto 1</div>
            <div class="photo-slot" id="slot2">Foto 2</div>
            <div class="photo-slot" id="slot3">Foto 3</div>
            <div class="photo-slot" id="slot4">Foto 4</div>
            <div class="photo-slot" id="slot5">Foto 5</div>
            <div class="photo-slot" id="slot6">Foto 6</div>
          </div>
        </div>

        <div class="controls-section">
          <div class="control-group">
            <h3>üñº Pilih Frame</h3>
            <div class="frame-selector">
              <div class="frame-option active" data-frame="none">
                Tanpa Frame
              </div>
              <div class="frame-option" data-frame="classic">Klasik</div>
              <div class="frame-option" data-frame="heart">Love</div>
              <div class="frame-option" data-frame="star">Bintang</div>
              <div class="frame-option" data-frame="floral">Bunga</div>
              <div class="frame-option" data-frame="geometric">Geometri</div>
            </div>
          </div>

          <div class="control-group">
            <h3>üé® Pilih Filter</h3>
            <div class="filter-selector">
              <div class="filter-option active" data-filter="none">Normal</div>
              <div class="filter-option" data-filter="grayscale">B&W</div>
              <div class="filter-option" data-filter="sepia">Sepia</div>
              <div class="filter-option" data-filter="vintage">Vintage</div>
              <div class="filter-option" data-filter="bright">Bright</div>
              <div class="filter-option" data-filter="contrast">Kontras</div>
            </div>
          </div>

          <div class="control-group">
            <h3>‚ú® Tambah Sticker</h3>
            <div class="sticker-selector">
              <div class="sticker-option" data-sticker="üòä">üòä</div>
              <div class="sticker-option" data-sticker="üòé">üòé</div>
              <div class="sticker-option" data-sticker="‚ù§">‚ù§</div>
              <div class="sticker-option" data-sticker="üéâ">üéâ</div>
              <div class="sticker-option" data-sticker="‚≠ê">‚≠ê</div>
              <div class="sticker-option" data-sticker="üåü">üåü</div>
              <div class="sticker-option" data-sticker="üéà">üéà</div>
              <div class="sticker-option" data-sticker="üéä">üéä</div>
              <div class="sticker-option" data-sticker="ü¶Ñ">ü¶Ñ</div>
            </div>
            <br />
            <button
              class="btn btn-secondary"
              id="clearStickers"
              style="margin: 10px auto; display: block; max-width: 250px"
            >
              Hapus Semua Sticker
            </button>
          </div>

          <div class="download-section">
            <button
              class="btn btn-success"
              id="downloadBtn"
              disabled
              style="width: 100%; font-size: 16px"
            >
              üíæ Download Semua Foto
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      class Photobooth {
        constructor() {
          this.video = document.getElementById("video");
          this.canvas = document.getElementById("canvas");
          this.ctx = this.canvas.getContext("2d");
          this.photos = Array(6).fill(null);
          this.retakeCount = 3;
          this.currentFrame = "none";
          this.currentFilter = "none";
          this.stickers = [];
          this.isFinished = false;

          this.initializeEventListeners();
          this.updateUI();
        }

        initializeEventListeners() {
          document
            .getElementById("startBtn")
            .addEventListener("click", () => this.startCamera());
          document
            .getElementById("captureBtn")
            .addEventListener("click", () => this.capturePhoto());
          document
            .getElementById("retakeBtn")
            .addEventListener("click", () => this.retakePhoto());
          document
            .getElementById("downloadBtn")
            .addEventListener("click", () => this.downloadPhotos());
          document
            .getElementById("clearStickers")
            .addEventListener("click", () => this.clearStickers());

          document.getElementById("uploadImage").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    const img = new Image();
    img.onload = () => {
  const isMobile = window.innerWidth <= 768;
  const canvasWidth = isMobile ? 600 : 800;
  const aspectRatio = img.naturalWidth / img.naturalHeight;
  const canvasHeight = canvasWidth / aspectRatio;

  this.canvas.width = canvasWidth;
  this.canvas.height = canvasHeight;

  // Gambar gambar dari galeri
  this.ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);

  // Tambahkan frame dan sticker seperti kamera
  this.drawFrameOnCanvas();
  this.drawStickersOnCanvas();

  // Tambahkan watermark
  this.drawWatermark();

  // Simpan ke slot foto
  const photoData = this.canvas.toDataURL("image/jpeg", 0.9);
  const slot = this.getNextSlotIndex();
  if (slot !== -1) {
    this.photos[slot] = photoData;
    this.updatePhotoStrip();
    this.updateUI();
    if (this.photos.every((p) => p !== null)) this.finishPhotos();
  }
};
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});


          // Frame selection
          document.querySelectorAll(".frame-option").forEach((option) => {
            option.addEventListener("click", (e) =>
              this.selectFrame(e.target.dataset.frame)
            );
          });

          // Filter selection
          document.querySelectorAll(".filter-option").forEach((option) => {
            option.addEventListener("click", (e) =>
              this.selectFilter(e.target.dataset.filter)
            );
          });

          // Sticker selection
          document.querySelectorAll(".sticker-option").forEach((option) => {
            option.addEventListener("click", (e) =>
              this.addSticker(e.target.dataset.sticker)
            );
          });

          // Photo deletion
          for (let i = 1; i <= 6; i++) {
            const slot = document.getElementById(`slot${i}`);
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "photo-delete-btn";
            deleteBtn.innerHTML = "√ó";
            deleteBtn.addEventListener("click", () => this.deletePhoto(i - 1));
            slot.appendChild(deleteBtn);
          }
        }

        async startCamera() {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "user",
                width: { ideal: 1280 },
                height: { ideal: 720 },
              },
              audio: false,
            });
            this.video.srcObject = stream;
            this.video.style.display = "block";
            document.getElementById("captureBtn").disabled = false;
            document.getElementById("startBtn").disabled = true;
          } catch (err) {
            alert(
              "Tidak dapat mengakses kamera. Pastikan Anda memberikan izin kamera."
            );
            console.error("Error accessing camera:", err);
          }
        }

        selectFrame(frame) {
          this.currentFrame = frame;
          document
            .querySelectorAll(".frame-option")
            .forEach((opt) => opt.classList.remove("active"));
          document
            .querySelector(`[data-frame="${frame}"]`)
            .classList.add("active");
          this.updateFrameOverlay();
        }

        selectFilter(filter) {
          this.currentFilter = filter;
          document
            .querySelectorAll(".filter-option")
            .forEach((opt) => opt.classList.remove("active"));
          document
            .querySelector(`[data-filter="${filter}"]`)
            .classList.add("active");
          this.applyVideoFilter();
        }

        applyVideoFilter() {
          const video = this.video;
          let filterStyle = "";

          switch (this.currentFilter) {
            case "grayscale":
              filterStyle = "grayscale(100%)";
              break;
            case "sepia":
              filterStyle = "sepia(100%)";
              break;
            case "vintage":
              filterStyle = "sepia(50%) contrast(120%) brightness(110%)";
              break;
            case "bright":
              filterStyle = "brightness(130%) contrast(110%)";
              break;
            case "contrast":
              filterStyle = "contrast(150%) saturate(120%)";
              break;
            default:
              filterStyle = "none";
          }

          video.style.filter = filterStyle;
        }

        updateFrameOverlay() {
          const overlay = document.getElementById("frameOverlay");
          let frameHTML = "";

          switch (this.currentFrame) {
            case "classic":
              frameHTML =
                '<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 25px solid; border-image: linear-gradient(45deg, #8B4513, #D2691E, #8B4513, #D2691E) 1;"></div>';
              break;
            case "heart":
              frameHTML = `
          <div style="position: absolute; top: 15px; left: 15px; font-size: 35px; animation: heartBeat 1.5s infinite;">üíñ</div>
          <div style="position: absolute; top: 15px; right: 15px; font-size: 35px; animation: heartBeat 1.8s infinite;">üíï</div>
          <div style="position: absolute; bottom: 15px; left: 15px; font-size: 35px; animation: heartBeat 2s infinite;">üíù</div>
          <div style="position: absolute; bottom: 15px; right: 15px; font-size: 35px; animation: heartBeat 1.3s infinite;">‚ù§</div>
          <div style="position: absolute; top: 50%; left: 15px; transform: translateY(-50%); font-size: 30px; animation: heartBeat 1.6s infinite;">üíó</div>
          <div style="position: absolute; top: 50%; right: 15px; transform: translateY(-50%); font-size: 30px; animation: heartBeat 1.9s infinite;">üíì</div>
        `;
              break;
            case "star":
              frameHTML = `
          <div style="position: absolute; top: 10px; left: 10px; font-size: 30px; animation: twinkle 2s infinite;">‚≠ê</div>
          <div style="position: absolute; top: 10px; right: 10px; font-size: 30px; animation: twinkle 2.5s infinite;">üåü</div>
          <div style="position: absolute; bottom: 10px; left: 10px; font-size: 30px; animation: twinkle 1.8s infinite;">‚ú®</div>
          <div style="position: absolute; bottom: 10px; right: 10px; font-size: 30px; animation: twinkle 2.2s infinite;">‚≠ê</div>
          <div style="position: absolute; top: 30%; left: 10px; font-size: 25px; animation: twinkle 1.5s infinite;">üåü</div>
          <div style="position: absolute; top: 70%; right: 10px; font-size: 25px; animation: twinkle 2.8s infinite;">‚ú®</div>
        `;
              break;
            case "floral":
              frameHTML = `
          <div style="position: absolute; top: 10px; left: 10px; font-size: 30px;">üå∏</div>
          <div style="position: absolute; top: 10px; right: 10px; font-size: 30px;">üå∫</div>
          <div style="position: absolute; bottom: 10px; left: 10px; font-size: 30px;">üåª</div>
          <div style="position: absolute; bottom: 10px; right: 10px; font-size: 30px;">üå∑</div>
          <div style="position: absolute; top: 30%; left: 5px; font-size: 25px;">üåπ</div>
          <div style="position: absolute; top: 60%; right: 5px; font-size: 25px;">üåº</div>
          <div style="position: absolute; top: 20%; right: 5px; font-size: 20px;">üçÉ</div>
          <div style="position: absolute; bottom: 30%; left: 5px; font-size: 20px;">üåø</div>
        `;
              break;
            case "geometric":
              frameHTML = `
          <div style="position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); transform: rotate(45deg);"></div>
          <div style="position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; background: linear-gradient(45deg, #45b7d1, #96ceb4); border-radius: 50%;"></div>
          <div style="position: absolute; bottom: 15px; left: 15px; width: 40px; height: 40px; background: linear-gradient(45deg, #ffeaa7, #fd79a8); clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
          <div style="position: absolute; bottom: 15px; right: 15px; width: 40px; height: 40px; background: linear-gradient(45deg, #a29bfe, #6c5ce7); transform: rotate(45deg);"></div>
        `;
              break;
          }

          overlay.innerHTML = frameHTML;
        }

        addSticker(emoji) {
          const overlay = document.getElementById("stickerOverlay");
          const sticker = document.createElement("div");
          sticker.className = "sticker";
          sticker.textContent = emoji;
          sticker.style.left = Math.random() * 70 + 15 + "%";
          sticker.style.top = Math.random() * 70 + 15 + "%";

          this.makeDraggable(sticker);
          overlay.appendChild(sticker);
          this.stickers.push(sticker);
        }

        makeDraggable(element) {
          let isDragging = false;
          let startX, startY, startLeft, startTop;

          const startDrag = (e) => {
            isDragging = true;
            const clientX =
              e.type === "mousedown" ? e.clientX : e.touches[0].clientX;
            const clientY =
              e.type === "mousedown" ? e.clientY : e.touches[0].clientY;
            startX = clientX;
            startY = clientY;
            startLeft = parseInt(element.style.left);
            startTop = parseInt(element.style.top);
            e.preventDefault();
          };

          element.addEventListener("mousedown", startDrag);
          element.addEventListener("touchstart", startDrag, { passive: false });

          const handleMove = (clientX, clientY) => {
            if (!isDragging) return;

            const deltaX = clientX - startX;
            const deltaY = clientY - startY;

            const newLeft =
              startLeft + (deltaX / element.parentElement.offsetWidth) * 100;
            const newTop =
              startTop + (deltaY / element.parentElement.offsetHeight) * 100;

            element.style.left = Math.max(0, Math.min(90, newLeft)) + "%";
            element.style.top = Math.max(0, Math.min(90, newTop)) + "%";
          };

          document.addEventListener("mousemove", (e) => {
            handleMove(e.clientX, e.clientY);
          });

          document.addEventListener(
            "touchmove",
            (e) => {
              if (isDragging && e.touches[0]) {
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
                e.preventDefault();
              }
            },
            { passive: false }
          );

          const stopDragging = () => {
            isDragging = false;
          };

          document.addEventListener("mouseup", stopDragging);
          document.addEventListener("touchend", stopDragging);

          // Double tap to remove
          let tapCount = 0;
          element.addEventListener("click", (e) => {
            tapCount++;
            setTimeout(() => {
              if (tapCount === 2) {
                element.remove();
                const index = this.stickers.indexOf(element);
                if (index > -1) this.stickers.splice(index, 1);
              }
              tapCount = 0;
            }, 300);
            e.stopPropagation();
          });
        }

        clearStickers() {
          const overlay = document.getElementById("stickerOverlay");
          overlay.innerHTML = "";
          this.stickers = [];
        }

        // Fixed: Always get the FIRST available slot (yang kosong)
        getNextSlotIndex() {
          return this.photos.findIndex((photo) => photo === null);
        }

        deletePhoto(index) {
          this.photos[index] = null;
          this.updatePhotoStrip();
          this.updateUI();

          // Re-enable capture if we're finished
          if (this.isFinished) {
            this.isFinished = false;
            document.getElementById("captureBtn").disabled = false;
          }
        }

        capturePhoto() {
          const nextSlotIndex = this.getNextSlotIndex();
          if (nextSlotIndex === -1) {
            this.finishPhotos();
            return;
          }

          const video = this.video;

          // Determine aspect ratio based on screen size
          const isMobile = window.innerWidth <= 768;
          let canvasWidth, canvasHeight;

          if (isMobile) {
            // Portrait untuk mobile
            canvasWidth = 600;
            canvasHeight = 800;
          } else {
            // Landscape untuk desktop
            canvasWidth = 800;
            canvasHeight = 600;
          }

          this.canvas.width = canvasWidth;
          this.canvas.height = canvasHeight;

          // Apply filter to canvas context
          this.ctx.filter = this.getCanvasFilter();

          // Draw mirrored video
          this.ctx.save();
          this.ctx.scale(-1, 1);
          this.ctx.drawImage(video, -canvasWidth, 0, canvasWidth, canvasHeight);
          this.ctx.restore();

          // Reset filter for overlays
          this.ctx.filter = "none";

          // Draw frame overlay
          this.drawFrameOnCanvas();

          // Draw stickers
          this.drawStickersOnCanvas();

          this.drawWatermark();

          const photoData = this.canvas.toDataURL("image/jpeg", 0.9);
          this.photos[nextSlotIndex] = photoData;

          this.updatePhotoStrip();
          this.updateUI();

          // Check if all photos are taken
          if (this.photos.every((photo) => photo !== null)) {
            this.finishPhotos();
          }
        }

        getCanvasFilter() {
          switch (this.currentFilter) {
            case "grayscale":
              return "grayscale(100%)";
            case "sepia":
              return "sepia(100%)";
            case "vintage":
              return "sepia(50%) contrast(120%) brightness(110%)";
            case "bright":
              return "brightness(130%) contrast(110%)";
            case "contrast":
              return "contrast(150%) saturate(120%)";
            default:
              return "none";
          }
        }

        drawFrameOnCanvas() {
          const ctx = this.ctx;
          const width = this.canvas.width;
          const height = this.canvas.height;

          ctx.save();

          switch (this.currentFrame) {
            case "classic":
              // Draw border frame
              const borderWidth = 40;
              const gradient = ctx.createLinearGradient(0, 0, width, height);
              gradient.addColorStop(0, "#8B4513");
              gradient.addColorStop(0.33, "#D2691E");
              gradient.addColorStop(0.66, "#8B4513");
              gradient.addColorStop(1, "#D2691E");

              ctx.strokeStyle = gradient;
              ctx.lineWidth = borderWidth;
              ctx.strokeRect(
                borderWidth / 2,
                borderWidth / 2,
                width - borderWidth,
                height - borderWidth
              );
              break;

            case "heart":
              // Draw heart emojis at corners and sides
              ctx.font = `${Math.min(width, height) * 0.08}px Arial`;
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";

              const hearts = ["üíñ", "üíï", "üíù", "‚ù§", "üíó", "üíì"];
              const positions = [
                { x: width * 0.1, y: height * 0.1 },
                { x: width * 0.9, y: height * 0.1 },
                { x: width * 0.1, y: height * 0.9 },
                { x: width * 0.9, y: height * 0.9 },
                { x: width * 0.05, y: height * 0.5 },
                { x: width * 0.95, y: height * 0.5 },
              ];

              hearts.forEach((heart, index) => {
                if (positions[index]) {
                  ctx.fillText(heart, positions[index].x, positions[index].y);
                }
              });
              break;

            case "star":
              // Draw star emojis
              ctx.font = `${Math.min(width, height) * 0.07}px Arial`;
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";

              const stars = ["‚≠ê", "üåü", "‚ú®", "‚≠ê", "üåü", "‚ú®"];
              const starPositions = [
                { x: width * 0.1, y: height * 0.1 },
                { x: width * 0.9, y: height * 0.1 },
                { x: width * 0.1, y: height * 0.9 },
                { x: width * 0.9, y: height * 0.9 },
                { x: width * 0.05, y: height * 0.3 },
                { x: width * 0.95, y: height * 0.7 },
              ];

              stars.forEach((star, index) => {
                if (starPositions[index]) {
                  ctx.fillText(
                    star,
                    starPositions[index].x,
                    starPositions[index].y
                  );
                }
              });
              break;

            case "floral":
              // Draw flower emojis
              ctx.font = `${Math.min(width, height) * 0.07}px Arial`;
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";

              const flowers = ["üå∏", "üå∫", "üåª", "üå∑", "üåπ", "üåº", "üçÉ", "üåø"];
              const flowerPositions = [
                { x: width * 0.1, y: height * 0.1 },
                { x: width * 0.9, y: height * 0.1 },
                { x: width * 0.1, y: height * 0.9 },
                { x: width * 0.9, y: height * 0.9 },
                { x: width * 0.05, y: height * 0.3 },
                { x: width * 0.95, y: height * 0.6 },
                { x: width * 0.95, y: height * 0.2 },
                { x: width * 0.05, y: height * 0.7 },
              ];

              flowers.forEach((flower, index) => {
                if (flowerPositions[index]) {
                  ctx.fillText(
                    flower,
                    flowerPositions[index].x,
                    flowerPositions[index].y
                  );
                }
              });
              break;

            case "geometric":
              // Draw geometric shapes
              const shapeSize = Math.min(width, height) * 0.06;

              // Square (rotated)
              ctx.save();
              ctx.translate(width * 0.1, height * 0.1);
              ctx.rotate(Math.PI / 4);
              const gradient1 = ctx.createLinearGradient(
                -shapeSize / 2,
                -shapeSize / 2,
                shapeSize / 2,
                shapeSize / 2
              );
              gradient1.addColorStop(0, "#ff6b6b");
              gradient1.addColorStop(1, "#4ecdc4");
              ctx.fillStyle = gradient1;
              ctx.fillRect(
                -shapeSize / 2,
                -shapeSize / 2,
                shapeSize,
                shapeSize
              );
              ctx.restore();

              // Circle
              ctx.save();
              ctx.beginPath();
              ctx.arc(width * 0.9, height * 0.1, shapeSize / 2, 0, 2 * Math.PI);
              const gradient2 = ctx.createLinearGradient(
                width * 0.9 - shapeSize / 2,
                height * 0.1 - shapeSize / 2,
                width * 0.9 + shapeSize / 2,
                height * 0.1 + shapeSize / 2
              );
              gradient2.addColorStop(0, "#45b7d1");
              gradient2.addColorStop(1, "#96ceb4");
              ctx.fillStyle = gradient2;
              ctx.fill();
              ctx.restore();

              // Triangle
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(width * 0.1, height * 0.9 - shapeSize / 2);
              ctx.lineTo(
                width * 0.1 - shapeSize / 2,
                height * 0.9 + shapeSize / 2
              );
              ctx.lineTo(
                width * 0.1 + shapeSize / 2,
                height * 0.9 + shapeSize / 2
              );
              ctx.closePath();
              const gradient3 = ctx.createLinearGradient(
                width * 0.1 - shapeSize / 2,
                height * 0.9 - shapeSize / 2,
                width * 0.1 + shapeSize / 2,
                height * 0.9 + shapeSize / 2
              );
              gradient3.addColorStop(0, "#ffeaa7");
              gradient3.addColorStop(1, "#fd79a8");
              ctx.fillStyle = gradient3;
              ctx.fill();
              ctx.restore();

              // Another rotated square
              ctx.save();
              ctx.translate(width * 0.9, height * 0.9);
              ctx.rotate(Math.PI / 4);
              const gradient4 = ctx.createLinearGradient(
                -shapeSize / 2,
                -shapeSize / 2,
                shapeSize / 2,
                shapeSize / 2
              );
              gradient4.addColorStop(0, "#a29bfe");
              gradient4.addColorStop(1, "#6c5ce7");
              ctx.fillStyle = gradient4;
              ctx.fillRect(
                -shapeSize / 2,
                -shapeSize / 2,
                shapeSize,
                shapeSize
              );
              ctx.restore();
              break;
          }

          ctx.restore();
        }

        drawStickersOnCanvas() {
          const ctx = this.ctx;
          const width = this.canvas.width;
          const height = this.canvas.height;

          ctx.save();
          ctx.font = `${Math.min(width, height) * 0.08}px Arial`;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";

          this.stickers.forEach((sticker) => {
            const relativeX = (parseFloat(sticker.style.left) / 100) * width;
            const relativeY = (parseFloat(sticker.style.top) / 100) * height;

            ctx.fillText(sticker.textContent, relativeX, relativeY);
          });

          ctx.restore();
        }

        drawWatermark() {
          const ctx = this.ctx;
          ctx.save();

          const now = new Date();
          const dateString = now.toLocaleDateString("id-ID", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          ctx.font = "bold 20px Arial";
          ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
          ctx.textAlign = "right";

          ctx.fillText(
            "Snapzify Photobooth",
            this.canvas.width - 20,
            this.canvas.height - 40
          );
          ctx.font = "16px Arial";
          ctx.fillText(
            dateString,
            this.canvas.width - 20,
            this.canvas.height - 20
          );

          ctx.restore();
        }

        retakePhoto() {
          if (this.retakeCount > 0) {
            this.retakeCount--;

            // Find last taken photo and remove it
            for (let i = this.photos.length - 1; i >= 0; i--) {
              if (this.photos[i] !== null) {
                this.photos[i] = null;
                break;
              }
            }

            this.updatePhotoStrip();
            this.updateUI();

            if (this.isFinished) {
              this.isFinished = false;
              document.getElementById("captureBtn").disabled = false;
            }
          }
        }

        finishPhotos() {
          this.isFinished = true;
          document.getElementById("captureBtn").disabled = true;
          document.getElementById("downloadBtn").disabled = false;
          alert("Semua foto sudah diambil! Silakan download hasil foto Anda.");
        }

        updatePhotoStrip() {
          for (let i = 0; i < 6; i++) {
            const slot = document.getElementById(`slot${i + 1}`);
            const img = slot.querySelector("img");

            if (this.photos[i]) {
              if (!img) {
                const newImg = document.createElement("img");
                newImg.src = this.photos[i];
                slot.innerHTML = "";
                slot.appendChild(newImg);

                // Re-add delete button
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "photo-delete-btn";
                deleteBtn.innerHTML = "√ó";
                deleteBtn.addEventListener("click", () => this.deletePhoto(i));
                slot.appendChild(deleteBtn);
              } else {
                img.src = this.photos[i];
              }
            } else {
              slot.innerHTML = `Foto ${i + 1}`;

              // Re-add delete button (hidden)
              const deleteBtn = document.createElement("button");
              deleteBtn.className = "photo-delete-btn";
              deleteBtn.innerHTML = "√ó";
              deleteBtn.addEventListener("click", () => this.deletePhoto(i));
              slot.appendChild(deleteBtn);
            }
          }
        }

        updateUI() {
          document.getElementById(
            "retakeCount"
          ).textContent = `Sisa Retake: ${this.retakeCount}`;
          document.getElementById("retakeBtn").disabled =
            this.retakeCount === 0 ||
            this.photos.every((photo) => photo === null);

          const filledSlots = this.photos.filter(
            (photo) => photo !== null
          ).length;
          document.getElementById("downloadBtn").disabled = filledSlots === 0;
        }

        async downloadPhotos() {
          const filledPhotos = this.photos.filter((photo) => photo !== null);

          if (filledPhotos.length === 0) {
            alert("Tidak ada foto untuk didownload!");
            return;
          }

          if (filledPhotos.length === 1) {
            // Download single photo
            this.downloadSinglePhoto(filledPhotos[0], "snapzify-photo.jpg");
          } else {
            // Create collage
            await this.createAndDownloadCollage(filledPhotos);
          }
        }

        downloadSinglePhoto(photoData, filename) {
          const link = document.createElement("a");
          link.href = photoData;
          link.download = filename;
          link.click();
        }

        async createAndDownloadCollage(photos) {
  const collageCanvas = document.createElement("canvas");
  const collageCtx = collageCanvas.getContext("2d");

  const isMobile = window.innerWidth <= 768;
  const headerHeight = 80;
  const cols = isMobile ? 2 : 3;
  const rows = Math.ceil(photos.length / cols);

  // Sementara nilai awal (akan diubah setelah gambar pertama dimuat)
  let photoWidth = 0;
  let photoHeight = 0;

  // Muat satu gambar dulu untuk ambil rasio asli
  const tempImg = new Image();
  tempImg.src = photos[0];
  await new Promise((resolve) => {
    tempImg.onload = () => {
      photoWidth = isMobile ? 350 : 400;
      const aspectRatio = tempImg.naturalWidth / tempImg.naturalHeight;
      photoHeight = photoWidth / aspectRatio;
      resolve();
    };
  });

  // Hitung ukuran canvas dari jumlah baris dan ukuran foto asli
  collageCanvas.width = cols * photoWidth;
  collageCanvas.height = rows * photoHeight + headerHeight;

  // Background putih
  collageCtx.fillStyle = "#ffffff";
  collageCtx.fillRect(0, 0, collageCanvas.width, collageCanvas.height);

  // Watermark Header
  collageCtx.font = "bold 28px Arial";
  collageCtx.fillStyle = "#444";
  collageCtx.textAlign = "center";
  const now = new Date();
  const dateString = now.toLocaleDateString("id-ID", {
    day: "numeric",
    month: "long",
    year: "numeric"
  });
  collageCtx.fillText(
    `üì∏ Snapzify Photobooth ‚Äì ${dateString}`,
    collageCanvas.width / 2,
    50
  );

  // Gambar semua foto
  const promises = photos.map((photoData, index) => {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
  const col = index % cols;
  const row = Math.floor(index / cols);
  const x = col * photoWidth;
  const y = row * photoHeight + headerHeight;

  // Gambar foto
  collageCtx.drawImage(img, x, y, photoWidth, photoHeight);

  // Tambahkan garis pembatas
collageCtx.strokeStyle = "#ffffff"; // putih
collageCtx.lineWidth = 4;
collageCtx.strokeRect(x, y, photoWidth, photoHeight);

  resolve();
};
      img.src = photoData;
    });
  });

  await Promise.all(promises);

  const collageData = collageCanvas.toDataURL("image/jpeg", 0.9);
  this.downloadSinglePhoto(collageData, "snapzify-collage.jpg");
}
      }

      // Initialize photobooth when page loads
      document.addEventListener("DOMContentLoaded", () => {
        new Photobooth();
      });
    </script>
  </body>
</html>
